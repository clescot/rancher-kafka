#!/bin/bash -x

# we add two more to make remote JMX easier/possible to access in a Docker
# environment:
#
#   1. RMI port - pinning this makes the JVM use a stable one instead of
#      selecting random high ports each time it starts up.
#   2. RMI hostname - normally set automatically by heuristics that may have
#      hard-to-predict results across environments.
#
# These allow saner configuration for firewalls, EC2 security groups, Docker
# hosts running in a VM with Docker Machine, etc. See:
#
# https://issues.apache.org/jira/browse/CASSANDRA-7087

set -e

while [ ! -f "/kafka/config/server.properties" ]; do
    sleep 1
done

if [ -e "/kafka/config/advertised-host-name" ]; then
KAFKA_ADVERTISED_HOST_NAME=$(</kafka/config/advertised-host-name)
export KAFKA_ADVERTISED_HOST_NAME
echo "file /kafka/config/advertised-host-name exist"
else 
    echo "File /kafka/config/advertised-host-name does not exist"
fi 

if [ "$ENABLE_JMX" = "true" ];then
    KAFKA_JMX_OPTS="-Dcom.sun.management.jmxremote=true"
    KAFKA_JMX_OPTS="$KAFKA_JMX_OPTS -Dcom.sun.management.jmxremote.authenticate=false"
    KAFKA_JMX_OPTS="$KAFKA_JMX_OPTS -Dcom.sun.management.jmxremote.ssl=false"
    KAFKA_JMX_OPTS="$KAFKA_JMX_OPTS -Dcom.sun.management.jmxremote.rmi.port=$JMX_PORT"
    KAFKA_JMX_OPTS="$KAFKA_JMX_OPTS -Djava.rmi.server.hostname=${JAVA_RMI_SERVER_HOSTNAME:-$KAFKA_ADVERTISED_HOST_NAME} "
    export KAFKA_JMX_OPTS
fi




echo " ###################################### /kafka/config/server.properties)"

echo "$(cat /kafka/config/server.properties)"
echo "Starting kafka"
exec /kafka/bin/kafka-server-start.sh /kafka/config/server.properties
